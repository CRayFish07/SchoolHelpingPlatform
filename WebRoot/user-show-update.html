<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="renderer" content="webkit|ie-comp|ie-stand">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<!--[if lt IE 9]>
<script type="text/javascript" src="assets/lib/html5shiv.js"></script>
<script type="text/javascript" src="assets/lib/respond.min.js"></script>
<![endif]-->
<link rel="stylesheet" type="text/css" href="assets/static/h-ui/css/H-ui.min.css" />
<link rel="stylesheet" type="text/css" href="assets/lib/Hui-iconfont/1.0.8/iconfont.css" />
<!--[if IE 6]>
<script type="text/javascript" src="assets/lib/DD_belatedPNG_0.0.8a-min.js" ></script>
<script>DD_belatedPNG.fix('*');</script>
<![endif]-->
<title>基本信息</title>
</head>
<body>
<article class="page-container">
	<div class="panel panel-default mt-20">
		<div class="panel-header">
			基本信息
		</div>
		<div class="panel-body">
			<form class="form form-horizontal" style="padding: 20px" id="form-user-show-update">
			<input type="hidden" name="uid" id="uid">
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>学号 / 工号：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-num">号码</span>
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>姓名：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-name">名称1</span>
					<input type="text" class="input-text" value="" placeholder="输入名称" id="name" name="name" style="display:none">
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>昵称：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-nickname">昵称1</span>
					<input type="text" class="input-text" value="" placeholder="输入名称" id="nickname" name="nickname" style="display:none">
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>学院：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-academy-name">学院1</span>
					<span id="span-academy" class="select-box" style="width:150px; display:none">
						<select id="academyuid" name="academyuid" class="select" size="1" onchange="init_user_course()">
							<option value="-1">请选择学院</option>
						</select>
					</span>
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>专业：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-course-name">专业1</span>
					<span id="span-course" class="select-box" style="width:150px; display:none">
						<select id="courseuid" name="courseuid" class="select" size="1">
							<option value="-1">请选择专业</option>
						</select>
					</span>
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>学年：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-grade-name">学年1</span>
					<span id="span-grade" class="select-box" style="width:150px; display:none">
						<select id="gradeuid" name="gradeuid" class="select" size="1">
							<option value="-1">请选择学年</option>
						</select>
					</span>
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>位置：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-location-name">位置1</span>
					<span id="span-location" class="select-box" style="width:150px; display:none">
						<select id="locationuid" name="locationuid" class="select" size="1">
							<option value="-1">请选择位置</option>
						</select>
					</span>
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3"><span class="c-red">*</span>角色：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-role-name">角色1</span>
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3">认证类型：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-qual-type-name">认证</span>
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3">信用值：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-credit-value">信用</span>
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3">创建时间：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-create-time">时间</span>
				</div>
			</div>
			<div class="row cl">
				<label class="form-label col-xs-4 col-sm-3">创建 IP 地址：</label>
				<div class="formControls col-xs-8 col-sm-9">
					<span id="span-create-ip">IP 地址</span>
				</div>
			</div>
			<div class="row cl">
				<div class="col-xs-8 col-sm-9 col-xs-offset-4 col-sm-offset-3">
					<input id="btn-chat" class="btn btn-primary radius" type="button" value="&nbsp;&nbsp;与 TA 聊天&nbsp;&nbsp;" onclick="chat()">
					<input id="btn-update" class="btn btn-primary radius" type="button" value="&nbsp;&nbsp;修改&nbsp;&nbsp;" onclick="change_to_update()" style="display:none">
					<input id="btn-submit" class="btn btn-primary radius" type="submit" value="&nbsp;&nbsp;提交&nbsp;&nbsp;" style="display:none">
				</div>
			</div>
			</form>
		</div>
	</div>
	<div class="panel panel-default mt-20">
	<div class="panel-header">
		帮助历史记录
    </div>
	<div class="panel-body">
		<table class="table table-border table-bordered table-hover">
			<thead>
				<tr class="text-c">
					<th width="10">ID</th>
					<th width="50">问题标题</th>
					<th width="40">问题解决者</th>
					<th width="40">问题协助者</th>
					<th width="40">处理时间</th>
				</tr>
			</thead>
			<tbody class="solve-history-content">
				<tr class="text-c solve-history-entry" style="display:none">
					<td tag="id">1</td>
					<td>
						<a tag="title" title="查看问题" href="javascript:;" onClick="problem_show('10001')" style="text-decoration:none" class="ml-5">模板 - 问题</a>
					</td>
					<td>
						<a tag="solve-user" title="查看用户" href="javascript:;" onClick="user_show('10001')" style="text-decoration:none" class="ml-5"> 用户 </a>
					</td>
					<td class="assistant-users-content">
						<a tag="solve-assistant-user" title="查看用户" href="javascript:;" onClick="user_show('10001')" style="text-decoration:none" class="ml-5"> 用户 </a>
					</td>
					<td tag="create-time">2017/10/01 10:00:00</td>
				</tr>
			</tbody>
		</table>
	</div>
	</div>
</article>

<!--_footer 作为公共模版分离出去-->
<script type="text/javascript" src="assets/lib/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript" src="assets/lib/layer/2.4/layer.js"></script> 
<script type="text/javascript" src="assets/static/h-ui/js/H-ui.min.js"></script>
<script type="text/javascript" src="assets/static/js/custom.js"></script>
<!--/_footer 作为公共模版分离出去-->

<!--请在下方写此页面业务相关的脚本-->
<script type="text/javascript" src="assets/lib/jquery.validation/1.14.0/jquery.validate.js"></script>
<script type="text/javascript" src="assets/lib/jquery.validation/1.14.0/validate-methods.js"></script>
<script type="text/javascript" src="assets/lib/jquery.validation/1.14.0/messages_zh.js"></script>
<script type="text/javascript">
$(document).ready(function(){
	var hint;
	
	var uid = $.getUrlParam("uid");
	var op = $.getUrlParam("op");
	
	if (uid == null && uid == "") {
		layer.msg("uid 参数异常, 无法初始化",{icon:2,time:1000});
		return;
	} else {
		$("#uid").val(uid);
	}
	
	switch(op) {
	case "update": {
		init_user(uid);
		init_solve_history(uid);
		change_to_update();
	}
	break;
	case "show":
	default: {
		init_user(uid);
		init_solve_history(uid);
	}
	}
	
	$.validator.addMethod("checkSelected", function(value, element, param) {
		if (value == "-1")
			return false;
		else
			return true;
	}, "请选择有效的选项");
	
	$("#form-user-show-update").validate({
		rules: {
			"name": {
				required: true,
				minlength: 2,
				maxlength: 16
			},
			"academyuid": {
				required: true,
				checkSelected: true
			},
			"courseuid": {
				required: true,
				checkSelected: true
			},
			"gradeuid": {
				required: true,
				checkSelected: true
			},
			"locationuid": {
				required: true,
				checkSelected: true
			},
			"roleuid": {
				required: true,
				checkSelected: true
			}
		},
		messages: {
			"name": "请输入姓名",
		},
		onkeyup: false,
		focusCleanup: true,
		success: "valid",
		submitHandler: function(form) {
			var params = $("#form-user-show-update").serialize();
			$.ajax({
				type: "post",
				data: params,
				dataType: "json",
				url: "user-update.action",
				success: function(result) {
					if (result.msgType == "success") {
						layer.msg("保存成功", {icon: 1, time: 1000});
					} else {
						layer.msg("失败<br>错误代码:" + result.msgCode + "<br>内容:" + result.msgContent, {
							icon : 2,
							shade: 0.4
						});
					}
				},
                error: function() {
					layer.msg("connection error!",{icon:2,time:1000});
				}
			});
		}
	});
});

function change_to_update() {
	$("#span-name").hide();
	$("#span-nickname").hide();
	$("#span-academy-name").hide();
	$("#span-course-name").hide();
	$("#span-grade-name").hide();
	$("#span-location-name").hide();
	$("#btn-update").hide();
	
	$("#name").show();
	$("#nickname").show();
	$("#span-academy").show();
	$("#span-course").show();
	$("#span-grade").show();
	$("#span-location").show();
	$("#btn-submit").show();
}

function chat() {
	var to_user_uid = $("#uid").val();
	if (to_user_uid == null || to_user_uid == "") {
		layer.msg("to_user_uid 参数异常",{icon:2,time:1000});
		return;
	}
	var from_user_uid = sessionStorage.getItem("userUid");
	if (from_user_uid == null || from_user_uid == "") {
		layer.msg("from_user_uid 参数异常",{icon:2,time:1000});
		return;
	}
	window.open(sessionStorage.getItem("chatBasePath") + "?from=" + from_user_uid + "&to=" + to_user_uid);
}

function init_user_academy() {
	var hint;
	$.ajax({
		url: "init.action",
		type: "post",
		dataType: "json",
		data: {
			t: "academy"
		},
		async: false,
		beforeSend: function() {
			hint = layer.msg("初始化中, 请稍后", {
				icon : 16,
				shade : 0.4,
				time : 0
			});
		},
		complete: function() {
			layer.close(hint);
		},
		success: function(result) {
		if (result.msgType == "success") {
			// do things here
			var content = result.msgContent;
			$.each(content, function(index, value) {
				$("#academyuid").append("<option value=\"" + value.uid + "\">" + value.name + "</option>");
			});
		} else {
			// do things here
			layer.msg("失败<br>错误代码:" + result.msgCode + "<br>内容:" + result.msgContent, {
				icon : 2,
				shade: 0.4
			});
		}
	},
	error: function() {
		layer.msg("connection error", {
			icon : 2,
			shade: 0.4
		});
	}
	});
}

function init_user_course() {
	var hint;
	var academyuid = $("#academyuid").val();
	if (academyuid == "-1") {
		return;
	}
	$.ajax({
		url: "init.action",
		type: "post",
		dataType: "json",
		data: {
			t: "course",
			uid: academyuid
		},
		async: false,
		beforeSend: function() {
			hint = layer.msg("初始化中, 请稍后", {
				icon : 16,
				shade : 0.4,
				time : 0
			});
		},
		complete: function() {
			layer.close(hint);
		},
		success: function(result) {
		if (result.msgType == "success") {
			// do things here
			var content = result.msgContent;
			$("#courseuid").empty();
			$.each(content, function(index, value) {
				$("#courseuid").append("<option value=\"" + value.uid + "\">" + value.name + "</option>");
			});
		} else {
			// do things here
			layer.msg("失败<br>错误代码:" + result.msgCode + "<br>内容:" + result.msgContent, {
				icon : 2,
				shade: 0.4
			});
		}
	},
	error: function() {
		layer.msg("connection error", {
			icon : 2,
			shade: 0.4
		});
	}
	});
}
function init_user_grade() {
	var hint;
	$.ajax({
		url: "init.action",
		type: "post",
		dataType: "json",
		data: {
			t: "grade"
		},
		async: false,
		beforeSend: function() {
			hint = layer.msg("初始化中, 请稍后", {
				icon : 16,
				shade : 0.4,
				time : 0
			});
		},
		complete: function() {
			layer.close(hint);
		},
		success: function(result) {
		if (result.msgType == "success") {
			// do things here
			var content = result.msgContent;
			$.each(content, function(index, value) {
				$("#gradeuid").append("<option value=\"" + value.uid + "\">" + value.name + "</option>");
			});
		} else {
			// do things here
			layer.msg("失败<br>错误代码:" + result.msgCode + "<br>内容:" + result.msgContent, {
				icon : 2,
				shade: 0.4
			});
		}
	},
	error: function() {
		layer.msg("connection error", {
			icon : 2,
			shade: 0.4
		});
	}
	});
}

function init_user_location() {
	var hint;
	$.ajax({
		url: "init.action",
		type: "post",
		dataType: "json",
		data: {
			t: "location"
		},
		async: false,
		beforeSend: function() {
			hint = layer.msg("初始化中, 请稍后", {
				icon : 16,
				shade : 0.4,
				time : 0
			});
		},
		complete: function() {
			layer.close(hint);
		},
		success: function(result) {
		if (result.msgType == "success") {
			// do things here
			var content = result.msgContent;
			$.each(content, function(index, value) {
				$("#locationuid").append("<option value=\"" + value.uid + "\">" + value.name + "</option>");
			});
		} else {
			// do things here
			layer.msg("失败<br>错误代码:" + result.msgCode + "<br>内容:" + result.msgContent, {
				icon : 2,
				shade: 0.4
			});
		}
	},
	error: function() {
		layer.msg("connection error", {
			icon : 2,
			shade: 0.4
		});
	}
	});
}

function init_user(uid) {
	var hint;
	$.ajax({
		url: "user-get.action",
		type: "post",
		dataType: "json",
		data: {
			uid: uid,
			type: "detail"
		},
		async: false,
		beforeSend: function() {
			hint = layer.msg("初始化中, 请稍后", {
				icon : 16,
				shade : 0.4,
				time : 0
			});
		},
		complete: function() {
			layer.close(hint);
		},
		success: function(result) {
		if (result.msgType == "success") {
			// do things here
			var content = result.msgContent;
			$.each(content, function(index, value) {
				var user_uid = sessionStorage.getItem("userUid");
				if (user_uid == value.uid) {
					$("#btn-update").show();
				}
				$("#span-num").html(value.num);
				$("#span-name").html(value.name);
				$("#name").val(value.name);
				if (value.nickname == null) {
					$("#span-nickname").html("暂无");
				} else {
					$("#span-nickname").html(value.nickname);
					$("#nickname").val(value.nickname);
				}
				init_user_academy();
				$("#academyuid").val(value.academy.uid);
				$("#span-academy-name").html(value.academy.name);
				init_user_course();
				$("#courseuid").val(value.course.uid);
				$("#span-course-name").html(value.course.name);
				init_user_grade();
				$("#gradeuid").val(value.grade.uid);
				$("#span-grade-name").html(value.grade.name);
				init_user_location();
				$("#locationuid").val(value.location.uid);
				$("#span-location-name").html(value.location.name);
				$("#span-role-name").html(value.role.name);
				if (value.qualtype == null) {
					$("#span-qual-type-name").html("暂无");
				} else if (value.qualtype.name == null) {
					$("#span-qual-type-name").html("暂无");
				} else {
					$("#span-qual-type-name").html(value.qualtype.name);
				}
				$("#span-credit-value").html(value.creditvalue);
				if (value.createtime <= 0) {
					$("#span-create-time").html("不可用");
				} else {
					$("#span-create-time").html(unixTimestamptoDateString(value.createtime));
				}
				if (value.createip == "-1") {
					$("#span-create-ip").html("不可用");
				} else {
					$("#span-create-ip").html(value.createip);
				}
			});
		} else {
			// do things here
			layer.msg("失败<br>错误代码:" + result.msgCode + "<br>内容:" + result.msgContent, {
				icon : 2,
				shade: 0.4
			});
		}
	},
	error: function() {
		layer.msg("connection error", {
			icon : 2,
			shade: 0.4
		});
	}
	});
}

function init_solve_history(uid) {
	$.ajax({
		url: "problem-get.action",
		type: "post",
		dataType: "json",
		data: {
			solvecreateuseruid: uid,
			type: "solve"
		},
		async: false,
		beforeSend: function() {
			hint = layer.msg("初始化中, 请稍后", {
				icon : 16,
				shade : 0.4,
				time : 0
			});
		},
		complete: function() {
			layer.close(hint);
		},
		success: function(result) {
 			if (result.msgType == "success") {
 				$("tbody tr:visible").empty();
				var content = result.msgContent;
				$.each(content, function(index, value) {
					var template = $(".solve-history-entry:last").clone();
					template.appendTo(".solve-history-content");
					template.find('[tag="id"]').html(index);
					template.find('[tag="title"]').html(value.problem.title);
					if (value.assistant == null || value.assistant.length == 0) {
						template.find(".assistant-users-content").empty();
						template.find(".assistant-users-content").html("无");
					} else {
						$.each(value.assistant, function(idx, v) {
							var tmp = template.find('[tag="solve-assistant-user"]:last');
							tmp.attr("onclick", "user_show('" + v.uid + "')");
							tmp.text(" " + v.name + " ");
							if (idx < value.assistant.length - 1) {
								tmp = tmp.clone();
								tmp.appendTo(template.find(".assistant-users-content"));
							}
						});
					}
					template.find('[tag="solve-user"]').attr("onclick", "user_show('" + value.createuser.uid + "')");
					template.find('[tag="solve-user"]').text(value.createuser.name);
					if (value.createtime <= 0) {
						template.find('[tag="create-time"]').html("不可用");
					} else {
						template.find('[tag="create-time"]').html(unixTimestamptoDateString(value.createtime));
					}
					template.show();
				});
		} else {
			// do things here
			layer.msg("失败<br>错误代码:" + result.msgCode + "<br>内容:" + result.msgContent, {
				icon : 2,
				shade: 0.4
			});
		}
	},
	error: function() {
		layer.msg("connection error", {
			icon : 2,
			shade: 0.4
		});
	}
	});
}

function user_show(uid) {
	if (uid == null || uid == "")
		uid = sessionStorage.getItem("userUid");
	layer_show("用户详情", "user-show-update.html?op=show&uid=" + uid, "600", "460");
}
</script> 
<!--/请在上方写此页面业务相关的脚本-->
</body>
</html>